<template>
  <b-modal
    id="task-modal"
    :no-close-on-esc="true"
    :no-close-on-backdrop="true"
    size="sm"
    @hidden="onClose()"
    @show="handleOpen()"
    @shown="focusInput()"
  >
    <div
      v-if="task"
      slot="modal-header"
      class="task-modal-header p-xl"
      :class="cssClass('bg')"
      @click="handleClick($event)"
    >
      <div class="d-flex align-items-center m-b-l">
        <h2
          class="my-auto"
          :class="cssClassHeadings"
        >
          {{ title }}
        </h2>
        <div class="ml-auto d-flex align-items-center">
          <span
            class="cancel-task-btn m-r-l"
            :class="cssClassHeadings"
            @click="cancel()"
          >{{ $t('cancel') }}</span>
          <div
            class="btn btn-secondary d-flex align-items-center justify-content-center"
            :class="{disabled: !canSave}"
            @click="submit()"
          >
            <div
              class="m-auto"
              v-if="purpose === 'edit'"
            >
              {{ $t('save') }}
            </div>
            <div
              class="m-auto"
              v-if="purpose === 'create'"
            >
              {{ $t('create') }}
            </div>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label
          :class="cssClassHeadings"
          class="m-b-xs"
        >{{ `${$t('text')}*` }}</label>
        <input
          ref="inputToFocus"
          v-model="task.text"
          class="form-control input-title"
          :class="cssClass('input')"
          type="text"
          required="required"
          spellcheck="true"
          :disabled="groupAccessRequiredAndOnPersonalPage || challengeAccessRequired"
          :placeholder="$t('addATitle')"
        >
      </div>
      <div class="form-group mb-0">
        <label
          class="d-flex align-items-center justify-content-between m-b-xs"
        >
          <span
            :class="cssClassHeadings"
          >{{ $t('notes') }}</span>
          <small>
            <a
              target="_blank"
              href="http://habitica.fandom.com/wiki/Markdown_Cheat_Sheet"
              :class="cssClassHeadings"
            >{{ $t('markdownHelpLink') }}</a>
          </small>
        </label>
        <textarea
          v-model="task.notes"
          class="form-control input-notes"
          :class="cssClass('input')"
          :placeholder="$t('notesUseMarkdown')"
        ></textarea>
      </div>
    </div>
    <div
      class="task-modal-content p-x-xl p-t-l"
      :class="cssClass('content')"
      @click="handleClick($event)"
    >
      <form
        v-if="task"
        @submit.stop.prevent="submit()"
        @click="handleClick($event)"
      >
        <div
          v-if="task.type === 'reward'"
          class="option mt-0 m-t-l"
        >
          <div class="form-group">
            <label v-once class="m-b-xs">{{ $t('cost') }}</label>
            <div class="input-group">
              <div class="input-group-prepend input-group-icon align-items-center">
                <div
                  class="svg-icon gold"
                  v-html="icons.gold"
                ></div>
              </div>
              <input
                v-model="task.value"
                class="form-control"
                type="number"
                required="required"
                placeholder="Enter a Value"
                step="0.01"
                min="0"
              >
            </div>
          </div>
        </div>
        <div
          v-if="checklistEnabled"
          class="option mt-0 m-t-l"
        >
          <label v-once class="m-b-xs">{{ $t('checklist') }}</label>
          <br>
          <draggable
            v-model="checklist"
            :options="{handle: '.grippy', filter: '.task-dropdown'}"
            @update="sortedChecklist"
          >
            <div
              v-for="(item, $index) in checklist"
              :key="item.id"
              class="inline-edit-input-group checklist-group input-group"
            >
              <span class="grippy" v-html="icons.grip">

              </span>

                <checkbox :checked.sync="item.completed"
                          class="input-group-prepend"
                :id="`checklist-${item.id}`"/>

              <input
                v-model="item.text"
                class="inline-edit-input checklist-item form-control"
                type="text"
              >
              <span
                class="input-group-append"
                @click="removeChecklistItem($index)"
              >
                <div
                  class="svg-icon destroy-icon"
                  v-html="icons.destroy"
                ></div>
              </span>
            </div>
          </draggable>
          <input
            v-model="newChecklistItem"
            class="inline-edit-input checklist-item form-control"
            type="text"
            :placeholder="$t('newChecklistItem')"
            @keypress.enter="setHasPossibilityOfIMEConversion(false)"
            @keyup.enter="addChecklistItem($event)"
          >
        </div>
        <div
          v-if="task.type === 'habit'"
          class="d-flex justify-content-center"
        >
          <div
            class="habit-option-container no-transition
              d-flex flex-column justify-content-center align-items-center"
            @click="toggleUpDirection()"
            :class="!task.up ? cssClass('habit-control-disabled') : ''"
          >
            <div
              class="habit-option-button no-transition
                d-flex justify-content-center align-items-center m-b-s"
              :class="task.up ? cssClass('bg') : ''"
            >
              <div
                class="habit-option-icon svg-icon no-transition"
                :class="task.up ? '' : 'disabled'"
                v-html="icons.positive"
              ></div>
            </div>
            <div
              class="habit-option-label no-transition"
              :class="task.up ? cssClass('icon') : 'disabled'"
            >
              {{ $t('positive') }}
            </div>
          </div>
          <div
            class="habit-option-container no-transition
              d-flex flex-column justify-content-center align-items-center"
            @click="toggleDownDirection()"
            :class="!task.down ? cssClass('habit-control-disabled') : ''"
          >
            <div
              class="habit-option-button no-transition
                d-flex justify-content-center align-items-center m-b-s"
              :class="task.down ? cssClass('bg') : ''"
            >
              <div
                class="habit-option-icon no-transition svg-icon negative mx-auto"
                :class="task.down ? '' : 'disabled'"
                v-html="icons.negative"
              ></div>
            </div>
            <div
              class="habit-option-label no-transition"
              :class="task.down ? cssClass('icon') : 'disabled'"
            >
              {{ $t('negative') }}
            </div>
          </div>
        </div>
        <template v-if="task.type !== 'reward'">
          <div class="d-flex align-items-center m-b-xs m-t-l">
            <label
              v-once
              class="mb-0 m-r-xs"
            >
              {{ $t('difficulty') }}
            </label>
            <div
              v-b-tooltip.hover.righttop="$t('difficultyHelp')"
              class="svg-icon info-icon mb-auto"
              v-html="icons.information"
            ></div>
          </div>
          <select-difficulty :value="task.priority"
                              @select="setDifficulty($event)"
          />

        </template>
        <div
          v-if="task.type === 'todo'"
          class="option m-t-l"
        >
          <div class="form-group">
            <label v-once class="m-b-xs">{{ $t('dueDate') }}</label>
            <datepicker
              v-model="task.date"
              :calendar-icon="icons.calendar"
              :clear-button="true"
              :clear-button-text="$t('clear')"
              :today-button="false"
              :disabled-picker="challengeAccessRequired"
              :highlighted="calendarHighlights"
            />
          </div>
        </div>
        <div
          v-if="task.type === 'daily'"
          class="option m-t-l"
        >
          <div class="form-group">
            <label v-once class="m-b-xs">{{ $t('startDate') }}</label>
            <datepicker
              v-model="task.startDate"
              :calendar-icon="icons.calendar"
              :clear-button="false"
              :today-button="false"
              :disabled-picker="challengeAccessRequired"
              :highlighted="calendarHighlights"
            />
          </div>
        </div>
        <div
          v-if="task.type === 'daily'"
          class="option m-t-l"
        >
          <div class="form-group">
            <label v-once class="m-b-xs">{{ $t('repeats') }}</label>
            <select-translated-array
              :disabled="challengeAccessRequired"
              :items="['daily', 'weekly', 'monthly', 'yearly']"
              :value="task.frequency"
              @select="task.frequency = $event"
            />
          </div>
          <div class="form-group">
            <label v-once class="m-b-xs">{{ $t('repeatEvery') }}</label>
            <div class="input-group-outer">
              <div class="input-group">
                <input
                  v-model="task.everyX"
                  class="form-control"
                  type="number"
                  min="0"
                  max="9999"
                  required="required"
                  :disabled="challengeAccessRequired"
                >

              </div>
              <div class="input-group-spaced input-group-text">
                {{ repeatSuffix }}
              </div>
            </div>
          </div>
          <template v-if="task.frequency === 'weekly'">
            <div class="form-group">
              <label
                v-once
                class="d-block m-b-xs"
              >{{ $t('repeatOn') }}</label>
              <div
                v-for="(day, dayNumber) in ['su','m','t','w','th','f','s']"
                :key="dayNumber"
                class="form-check-inline weekday-check mr-0"
              >
                <div class="custom-control custom-checkbox custom-control-inline">
                  <input
                    :id="`weekday-${dayNumber}`"
                    v-model="task.repeat[day]"
                    class="custom-control-input"
                    type="checkbox"
                    :disabled="challengeAccessRequired"
                  >
                  <label
                    v-once
                    class="custom-control-label m-b-xs"
                    :for="`weekday-${dayNumber}`"
                  >{{ weekdaysMin(dayNumber) }}</label>
                </div>
              </div>
            </div>
          </template>
          <template v-if="task.frequency === 'monthly'">
            <label
              v-once
              class="d-block m-b-xs"
            >{{ $t('repeatOn') }}</label>
            <div class="form-radio">
              <div class="custom-control custom-radio custom-control-inline">
                <input
                  id="repeat-dayOfMonth"
                  v-model="repeatsOn"
                  class="custom-control-input"
                  type="radio"
                  value="dayOfMonth"
                  name="repeatsOn"
                >
                <label
                  class="custom-control-label m-b-xs"
                  for="repeat-dayOfMonth"
                >{{ $t('dayOfMonth') }}</label>
              </div>
              <div class="custom-control custom-radio custom-control-inline">
                <input
                  id="repeat-dayOfWeek"
                  v-model="repeatsOn"
                  class="custom-control-input"
                  type="radio"
                  value="dayOfWeek"
                  name="repeatsOn"
                >
                <label
                  class="custom-control-label m-b-xs"
                  for="repeat-dayOfWeek"
                >{{ $t('dayOfWeek') }}</label>
              </div>
            </div>
          </template>
        </div>
        <div
          v-if="isUserTask"
          class="tags-select option m-t-l"
        >
          <div class="tags-inline form-group row">
            <label
              v-once
              class="col-12 m-b-xs"
            >{{ $t('tags') }}</label>
            <div class="col-12">
              <select-tag :selected-tags="task.tags"
                          :all-tags="user.tags"
                          @changed="task.tags = $event"
                          ref="selectTag" />
            </div>
          </div>
        </div>
        <div
          v-if="task.type === 'habit'"
          class="option m-t-l"
        >
          <div class="form-group">
            <label v-once class="m-b-xs">{{ $t('resetStreak') }}</label>
            <select-translated-array
              :disabled="challengeAccessRequired"
              :items="['daily', 'weekly', 'monthly']"
              :value="task.frequency"
              @select="task.frequency = $event"
            />
          </div>
        </div>
        <div
          v-if="groupId"
          class="option group-options m-t-l"
        >
          <div
            v-if="task.type === 'todo'"
            class="form-group"
          >
            <label v-once class="m-b-xs">{{ $t('sharedCompletion') }}</label>
            <select-translated-array
              :items="['recurringCompletion', 'singleCompletion', 'allAssignedCompletion']"
              :value="sharedCompletion"
              @select="sharedCompletion = $event"
            />
          </div>
          <div class="form-group row">
            <label
              v-once
              class="col-12 m-b-xs"
            >{{ $t('assignedTo') }}</label>
            <div class="col-12">
              <div
                class="dropdown inline-dropdown"
                @click="showAssignedSelect = !showAssignedSelect"
              >
                <span
                  v-if="assignedMembers && assignedMembers.length === 0"
                  class="btn dropdown-toggle btn-secondary"
                >{{ $t('none') }}</span>
                <span
                  v-else
                  class="btn dropdown-toggle btn-secondary"
                >
                  <span
                    v-for="memberId in assignedMembers"
                    :key="memberId"
                    class="mr-1"
                  >{{ memberNamesById[memberId] }}</span>
                </span>
              </div>
              <div
                v-if="showAssignedSelect"
                class="category-box"
              >
                <div class="container">
                  <div class="row">
                    <div
                      v-for="member in members"
                      :key="member._id"
                      class="form-check col-6"
                    >
                      <div class="custom-control custom-checkbox">
                        <input
                          :id="`assigned-${member._id}`"
                          v-model="assignedMembers"
                          class="custom-control-input"
                          type="checkbox"
                          :value="member._id"
                          @change="toggleAssignment(member._id)"
                        >
                        <label
                          v-once
                          class="custom-control-label"
                          :for="`assigned-${member._id}`"
                        >{{ member.profile.name }}</label>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <button
                      class="btn btn-primary"
                      @click.stop.prevent="showAssignedSelect = !showAssignedSelect"
                    >
                      {{ $t('close') }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="form-group flex-group">
            <label v-once class="m-b-xs flex">{{ $t('approvalRequired') }}</label>
            <toggle-switch
              class="d-inline-block"
              :checked="requiresApproval"
              @change="updateRequiresApproval"
            />
          </div>
        </div>
        <div
          v-if="advancedSettingsAvailable"
          class="advanced-settings"
        >
          <div
            class="advanced-settings-toggle d-flex justify-content-between align-items-center"
            @click="showAdvancedOptions = !showAdvancedOptions"
          >
            <h3>{{ $t('advancedSettings') }}</h3>
            <div class="toggle-up">
              <div
                class="svg-icon"
                :class="{'toggle-open': showAdvancedOptions}"
                v-html="icons.down"
              ></div>
            </div>
          </div>
          <b-collapse
            id="advancedOptionsCollapse"
            v-model="showAdvancedOptions"
          >
            <div class="advanced-settings-body">
              <div
                v-if="task.type === 'daily' && isUserTask && purpose === 'edit'"
                class="option m-t-l"
              >
                <div class="form-group">
                  <label v-once class="m-b-xs">{{ $t('restoreStreak') }}</label>
                  <div class="input-group">
                    <div class="input-group-prepend streak-addon input-group-icon">
                      <div
                        class="svg-icon"
                        v-html="icons.streak"
                      ></div>
                    </div>
                    <input
                      v-model="task.streak"
                      class="form-control"
                      type="number"
                      min="0"
                      required="required"
                    >
                  </div>
                </div>
              </div>
              <div
                v-if="task.type === 'habit'
                  && isUserTask && purpose === 'edit' && (task.up || task.down)"
                class="option m-t-l"
              >
                <div class="form-group">
                  <label v-once class="m-b-xs">{{ $t('restoreStreak') }}</label>
                  <div class="row">
                    <div
                      v-if="task.up"
                      class="col-6"
                    >
                      <div class="input-group">
                        <div class="input-group-prepend positive-addon input-group-icon">
                          <div
                            class="svg-icon"
                            v-html="icons.positive"
                          ></div>
                        </div>
                        <input
                          v-model="task.counterUp"
                          class="form-control"
                          type="number"
                          min="0"
                          required="required"
                        >
                      </div>
                    </div>
                    <div
                      v-if="task.down"
                      class="col-6"
                    >
                      <div class="input-group">
                        <div class="input-group-prepend negative-addon input-group-icon">
                          <div
                            class="svg-icon"
                            v-html="icons.negative"
                          ></div>
                        </div>
                        <input
                          v-model="task.counterDown"
                          class="form-control"
                          type="number"
                          min="0"
                          required="required"
                        >
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!--.option(v-if="isUserTask && task.type !== 'reward'").form-group
  label(v-once)
    span.float-left {{ $t('attributeAllocation') }}
    .svg-icon.info-icon(v-html="ic
    ons.information", v-b-tooltip.hover.righttop.html="$t('attributeAllocationHelp')")
  .attributes
    .custom-control.custom-radio.custom-
    control-inline(v-for="attr in ATTRIBUTES", :key="attr")
      input.custom-control-input(:id="`attribute-${a
      ttr}`", type="radio", :value="attr", v-model="task.attribute", :disabled="us
      er.preferences.allocationMode !== 'taskbased'")
              label.custom-control-label.attr-
              description(:for="`attribute-${attr}`", v-once, v-b-pop
              over.hover="$t(`${attr}Text`)") {{ $t(attributesStrings[attr]) }}-->
            </div>
          </b-collapse>
        </div>
        <div
          v-if="purpose !== 'create' && !challengeAccessRequired"
          class="delete-task-btn d-flex justify-content-center align-items-middle"
          @click="destroy()"
        >
          <div
            class="svg-icon d-inline-b"
            v-html="icons.destroy"
          ></div>
          <span>{{ $t('deleteTask') }}</span>
        </div>
      </form>
    </div>
    <div
      slot="modal-footer"
      class="task-modal-footer d-flex justify-content-center align-items-center"
      @click="handleClick($event)"
    >
      <div
        v-if="purpose === 'create'"
        class="btn btn-primary btn-footer
          d-flex align-items-center justify-content-center m-t-s m-b-s"
        :class="{disabled: !canSave}"
        @click="submit()"
      >
        {{ $t('create') }}
      </div>
    </div>
  </b-modal>
</template>

<style lang="scss">
  @import '~@/assets/scss/colors.scss';

  #task-modal {
    .modal-dialog.modal-sm {
      max-width: 448px;
    }

    .no-transition {
      transition: none;
    }

    input, textarea {
      border: none;
      transition-property: border-color, box-shadow, color, background;
      background-color: rgba(255, 255, 255, 0.5);

      &:focus, &:active, &:hover {
        background-color: rgba(255, 255, 255, 0.75);
      }
    }

    .modal-content {
      border-radius: 8px;
      border: none;
    }

    .modal-body {
      // the body has a margin/padding that can't be found
      // if found please remove that padding and this style
      margin-bottom: -1rem;
    }

    .modal-header, .modal-body, .modal-footer {
      padding: 0px;
      border: none;
    }

    .task-modal-header {
      color: $white;
      width: 100%;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;

      h2 {
        color: $white;
      }
    }

    .info-icon {
      float: left;
      height: 16px;
      width: 16px;
      margin-top: 2px;
      color: $gray-200;
    }

    .option {
      position: relative;

      .custom-control-label p {
        word-break: break-word;
      }
    }

    .option-item {
      margin-right: 48px;
      cursor: pointer;

      &:last-child {
        margin-right: 0px;
      }

      &-box {
        width: 64px;
        height: 64px;
        border-radius: 2px;
        background: $gray-600;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      &-label {
        color: $gray-50;
        text-align: center;
        transition-property: none;
      }
    }

    .category-wrap {
      cursor: pointer;
      margin-top: 0px;
      width: 100%;
    }

    .category-box {
      bottom: 0px;
      left: 40px;
      top: auto;
      z-index: 11;

      .container {
        max-height: 90vh;
        overflow: auto;
      }
    }

    .checklist-group {
      border-top: 1px solid $gray-500;

      .input-group-append {
        background: inherit;
      }

      .checklist-item {
        padding-left: 12px;
      }
    }

    span.grippy {
      position: absolute;
      left: -15px;
      width: 0.625rem;
      height: 1rem;
      object-fit: contain;
      color: $gray-200;
      top: 4px;
    }

    .checklist-item {
      margin-bottom: 0px;
      border-radius: 0px;
      border: none !important;
      padding-left: 36px;

      &:last-child {
        background-repeat: no-repeat;
        background-position: center left 10px;
        border-top: 1px solid $gray-500 !important;
        border-bottom: 1px solid $gray-500 !important;
        background-size: 10px 10px;
        background-image: url(~@/assets/svg/for-css/positive.svg);
      }
    }

    .checklist-group {
      .grippy {
        opacity: 0;
        cursor: pointer;

        &:hover, &:active {
          opacity: 1;
        }
      }

      .destroy-icon {
        display: none;
      }

      &:hover {
        cursor: text;

        .destroy-icon {
          display: inline-block;
          color: $gray-200;
        }

        .grippy {
          display: inline-block;

        }
      }
    }

    .delete-task-btn, .cancel-task-btn {
      cursor: pointer;

      &:hover, &:focus, &:active {
        text-decoration: underline;
      }
    }

    .delete-task-btn {
      margin-top: 32px;
      margin-bottom: 8px;
      color: $red-50;

      .svg-icon {
        width: 14px;
        height: 16px;
        margin-right: 8.5px;
      }
    }

    .task-modal-footer {
      margin: 0;
      padding: 16px 24px;
      width: 100%;

      .cancel-task-btn {
        margin-right: 16px;
        color: $blue-10;
      }
    }

    .weekday-check {
      margin-left: 0px;
      width: 57px;
    }

    .advanced-settings {
      background: $gray-700;
      padding: 16px 24px;
      margin: -8px -24px;

      &-toggle {
        cursor: pointer;
      }

      &-body {
        margin-top: 17px;
      }

      h3 {
        color: $gray-10;
        margin-bottom: 0px;
      }

      .attributes .custom-control {
        margin-right: 40px;
      }

      .toggle-open {
        transform: rotate(180deg);
      }

      .attr-description {
        border-bottom: 1px dashed;
      }
    }
  }

  @media only screen and (max-width: 768px) {
    .option-item {
      margin-right: 12px !important;
    }
  }
</style>

<style lang="scss" scoped>
  @import '~@/assets/scss/colors.scss';

  .gold {
    width: 1rem;
    height: 1rem;
  }

  .habit-option {
    &-container {
      min-width: 3rem;
      cursor: pointer;

      &:first-of-type {
        margin-right: 2rem;
      }
    }

    &-button {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
    }

    &-icon {
      width: 10px;
      height: 10px;
      color: $white;

      &.disabled {
        color: $gray-200;
      }

      &.negative {
        margin-top: 0.5rem;
      }
    }

    &-label {
      font-size: 12px;
      font-weight: bold;
      text-align: center;

      &.disabled {
        color: $gray-100;
        font-weight: normal;
      }
    }
  }

  input, textarea, input.form-control, textarea.form-control {
    padding: 0.25rem 0.75rem;
    line-height: 1.71;
  }

  .input-title {
    height: 2rem;
  }

  .input-notes {
    height: 3.5rem;
  }

  label {
    font-size: 14px;
    font-weight: bold;
    line-height: 1.71;
  }

  .flex-group {
    display: flex;

    .flex {
      flex: 1;
    }
  }

</style>

<script>
import clone from 'lodash/clone';
import Datepicker from 'vuejs-datepicker';
import moment from 'moment';
import uuid from 'uuid';
import draggable from 'vuedraggable';
import toggleSwitch from '@/components/ui/toggleSwitch';
import checkbox from '@/components/ui/checkbox';
import markdownDirective from '@/directives/markdown';
import { mapGetters, mapActions, mapState } from '@/libs/store';
import SelectTag from './modal-controls/selectTag';
import selectDifficulty from '@/components/tasks/modal-controls/selectDifficulty';
import selectTranslatedArray from '@/components/tasks/modal-controls/selectTranslatedArray';

import informationIcon from '@/assets/svg/information.svg';
import positiveIcon from '@/assets/svg/positive.svg';
import negativeIcon from '@/assets/svg/negative.svg';
import streakIcon from '@/assets/svg/streak.svg';
import deleteIcon from '@/assets/svg/delete.svg';
import goldIcon from '@/assets/svg/gold.svg';
import downIcon from '@/assets/svg/down.svg';
import calendarIcon from '@/assets/svg/calendar.svg';
import gripIcon from '@/assets/svg/grip.svg';

export default {
  components: {
    SelectTag,
    Datepicker,
    toggleSwitch,
    draggable,
    selectDifficulty,
    selectTranslatedArray,
    checkbox,
  },
  directives: {
    markdown: markdownDirective,
  },
  // purpose is either create or edit, task is the task created or edited
  props: ['task', 'purpose', 'challengeId', 'groupId'],
  data () {
    return {
      showAssignedSelect: false,
      newChecklistItem: null,
      icons: Object.freeze({
        information: informationIcon,
        negative: negativeIcon,
        positive: positiveIcon,
        destroy: deleteIcon,
        gold: goldIcon,
        down: downIcon,
        streak: streakIcon,
        calendar: calendarIcon,
        grip: gripIcon,
      }),
      requiresApproval: false, // We can't set task.group fields so we use this field to toggle
      sharedCompletion: 'singleCompletion',
      members: [],
      memberNamesById: {},
      assignedMembers: [],
      checklist: [],
      showAdvancedOptions: false,
      attributesStrings: {
        str: 'strength',
        int: 'intelligence',
        con: 'constitution',
        per: 'perception',
      },
      calendarHighlights: { dates: [new Date()] },
      hasPossibilityOfIMEConversion: true,
    };
  },
  computed: {
    ...mapGetters({
      getTaskClasses: 'tasks:getTaskClasses',
      canDeleteTask: 'tasks:canDelete',
    }),
    ...mapState({
      user: 'user.data',
      dayMapping: 'constants.DAY_MAPPING',
      ATTRIBUTES: 'constants.ATTRIBUTES',
    }),
    advancedSettingsAvailable () {
      if (
        this.task.type === 'reward'
        || this.task.type === 'todo'
        || this.purpose === 'create'
        || !this.isUserTask
      ) return false;
      return true;
    },
    groupAccessRequiredAndOnPersonalPage () {
      if (!this.groupId && this.task.group && this.task.group.id) return true;
      return false;
    },
    checklistEnabled () {
      return ['daily', 'todo'].indexOf(this.task.type) > -1 && !this.isOriginalChallengeTask;
    },
    isChallengeTask () {
      return Boolean(this.task.challenge && this.task.challenge.id);
    },
    onUserPage () {
      return !this.challengeId && !this.groupId;
    },
    challengeAccessRequired () {
      return this.onUserPage && this.isChallengeTask;
    },
    isOriginalChallengeTask () {
      const isUserChallenge = Boolean(this.task.userId);
      return !isUserChallenge
        && (this.challengeId || (this.task.challenge && this.task.challenge.id));
    },
    canDelete () {
      return this.purpose !== 'create' && this.canDeleteTask(this.task);
    },
    canSave () {
      return this.task && this.task.text && this.task.text.length > 0;
    },
    title () {
      const type = this.$t(this.task.type);
      return this.$t(this.purpose === 'edit' ? 'editATask' : 'createTask', { type });
    },
    isUserTask () {
      return !this.challengeId && !this.groupId;
    },
    repeatSuffix () {
      const { task } = this;

      // once changed it is a string
      const everyXValue = +task.everyX;

      if (task.frequency === 'daily') {
        return everyXValue === 1 ? this.$t('day') : this.$t('days');
      } if (task.frequency === 'weekly') {
        return everyXValue === 1 ? this.$t('week') : this.$t('weeks');
      } if (task.frequency === 'monthly') {
        return everyXValue === 1 ? this.$t('month') : this.$t('months');
      } if (task.frequency === 'yearly') {
        return everyXValue === 1 ? this.$t('year') : this.$t('years');
      }
      return null;
    },
    repeatsOn: {
      get () {
        let repeatsOn = 'dayOfMonth';

        if (this.task.type === 'daily' && this.task.weeksOfMonth && this.task.weeksOfMonth.length > 0) {
          repeatsOn = 'dayOfWeek';
        }

        return repeatsOn;
      },
      set (newRepeatsOn) {
        this.calculateMonthlyRepeatDays(newRepeatsOn);
      },
    },
    selectedTags () {
      return this.getTagsFor(this.task);
    },
    cssClassHeadings () {
      const textClass = this.cssClass('text');
      if (textClass.indexOf('purple') !== -1 || textClass.indexOf('worst') !== -1) return null;
      return textClass;
    },
  },
  watch: {
    task () {
      this.syncTask();
    },
    'task.startDate': function taskStartDate () {
      this.calculateMonthlyRepeatDays();
    },
    'task.frequency': function taskFrequency () {
      this.calculateMonthlyRepeatDays();
    },
  },
  mounted () {
    this.showAdvancedOptions = !this.user.preferences.advancedCollapsed;
  },
  created () {
    document.addEventListener('keyup', this.handleEsc);
  },
  beforeDestroy () {
    document.removeEventListener('keyup', this.handleEsc);
  },
  methods: {
    ...mapActions({ saveTask: 'tasks:save', destroyTask: 'tasks:destroy', createTask: 'tasks:create' }),
    async syncTask () {
      if (this.groupId && this.task.group && this.task.group.approval) {
        this.requiresApproval = this.task.group.approval.required;
      }

      if (this.groupId) {
        const members = await this.$store.dispatch('members:getGroupMembers', {
          groupId: this.groupId,
          includeAllPublicFields: true,
        });
        this.members = members;
        this.members.forEach(member => {
          this.memberNamesById[member._id] = member.profile.name;
        });
        this.assignedMembers = [];
        if (this.task.group && this.task.group.assignedUsers) {
          this.assignedMembers = this.task.group.assignedUsers;
        }
        if (this.task.group) {
          this.sharedCompletion = this.task.group.sharedCompletion || 'singleCompletion';
        }
      }

      // @TODO: This whole component is mutating a prop
      // and that causes issues. We need to not copy the prop similar to group modals
      if (this.task) this.checklist = clone(this.task.checklist);
    },
    async handleOpen () {
      this.syncTask();
    },
    cssClass (suffix) {
      return this.task
        ? this.getTaskClasses(this.task, `${this.purpose === 'edit' ? 'edit' : 'create'}-modal-${suffix}`)
        : '';
    },
    setDifficulty (level) {
      if (this.challengeAccessRequired) return;
      this.task.priority = level;
    },
    toggleUpDirection () {
      if (this.challengeAccessRequired) return;
      this.task.up = !this.task.up;
    },
    toggleDownDirection () {
      if (this.challengeAccessRequired) return;
      this.task.down = !this.task.down;
    },
    sortedChecklist (data) {
      const sorting = clone(this.task.checklist);
      const movingItem = sorting[data.oldIndex];
      sorting.splice(data.oldIndex, 1);
      sorting.splice(data.newIndex, 0, movingItem);
      this.task.checklist = sorting;
    },
    setHasPossibilityOfIMEConversion (bool) {
      this.hasPossibilityOfIMEConversion = bool;
    },
    addChecklistItem (e) {
      if (e) e.preventDefault();
      if (this.hasPossibilityOfIMEConversion) return;
      const checkListItem = {
        id: uuid.v4(),
        text: this.newChecklistItem,
        completed: false,
      };
      this.task.checklist.push(checkListItem);
      // @TODO: managing checklist separately to help with sorting on the UI
      this.checklist.push(checkListItem);
      this.newChecklistItem = null;
      this.setHasPossibilityOfIMEConversion(true);
    },
    removeChecklistItem (i) {
      this.task.checklist.splice(i, 1);
      this.checklist = clone(this.task.checklist);
    },
    weekdaysMin (dayNumber) {
      return moment.weekdaysMin(dayNumber);
    },
    calculateMonthlyRepeatDays (newRepeatsOn) {
      if (!this.task) return;
      const { task } = this;
      const repeatsOn = newRepeatsOn || this.repeatsOn;

      if (task.frequency === 'monthly') {
        if (repeatsOn === 'dayOfMonth') {
          const date = moment(task.startDate).date();
          task.weeksOfMonth = [];
          task.daysOfMonth = [date];
        } else if (repeatsOn === 'dayOfWeek') {
          const week = Math.ceil(moment(task.startDate).date() / 7) - 1;
          const dayOfWeek = moment(task.startDate).day();
          const shortDay = this.dayMapping[dayOfWeek];
          task.daysOfMonth = [];
          task.weeksOfMonth = [week];
          for (const key of Object.keys(task.repeat)) {
            task.repeat[key] = false;
          }
          task.repeat[shortDay] = true;
        }
      }
    },
    async submit () {
      if (!this.canSave) return;
      if (this.newChecklistItem) this.addChecklistItem();

      // TODO Fix up permissions on task.group so we don't have to keep doing these hacks
      if (this.groupId) {
        this.task.requiresApproval = this.requiresApproval;
        this.task.group.approval.required = this.requiresApproval;
        this.task.sharedCompletion = this.sharedCompletion;
        this.task.group.sharedCompletion = this.sharedCompletion;
      }

      if (this.task.type === 'reward' && this.task.value === '') {
        this.task.value = 0;
      }

      if (this.purpose === 'create') {
        if (this.challengeId) {
          const response = await this.$store.dispatch('tasks:createChallengeTasks', {
            challengeId: this.challengeId,
            tasks: [this.task],
          });
          Object.assign(this.task, response);
          this.$emit('taskCreated', this.task);
        } else if (this.groupId) {
          const response = await this.$store.dispatch('tasks:createGroupTasks', {
            groupId: this.groupId,
            tasks: [this.task],
          });
          Object.assign(this.task, response);
          const promises = this.assignedMembers.map(memberId => this.$store.dispatch('tasks:assignTask', {
            taskId: this.task._id,
            userId: memberId,
          }));
          Promise.all(promises);
          this.task.group.assignedUsers = this.assignedMembers;
          this.$emit('taskCreated', this.task);
        } else {
          this.createTask(this.task);
        }
      } else {
        this.saveTask(this.task);
        this.$emit('taskEdited', this.task);
      }
      this.$root.$emit('bv::hide::modal', 'task-modal');
    },
    destroy () {
      if (!window.confirm(this.$t('sureDelete'))) return;
      this.destroyTask(this.task);
      this.$emit('taskDestroyed', this.task);
      this.$root.$emit('bv::hide::modal', 'task-modal');
    },
    cancel () {
      this.$root.$emit('bv::hide::modal', 'task-modal');
    },
    onClose () {
      this.closeTagsPopup();
      this.newChecklistItem = '';
      this.$emit('cancel');
    },
    updateRequiresApproval (newValue) {
      let truthy = true;
      if (!newValue) truthy = false; // This return undefined instad of false
      this.requiresApproval = truthy;
    },
    async toggleAssignment (memberId) {
      const assignedIndex = this.assignedMembers.indexOf(memberId);

      if (assignedIndex === -1) {
        if (this.purpose === 'create') {
          return;
        }

        await this.$store.dispatch('tasks:unassignTask', {
          taskId: this.task._id,
          userId: memberId,
        });
        return;
      }

      if (this.purpose === 'create') {
        return;
      }

      await this.$store.dispatch('tasks:assignTask', {
        taskId: this.task._id,
        userId: memberId,
      });
    },
    focusInput () {
      this.$refs.inputToFocus.focus();
    },
    handleEsc (e) {
      if (e.keyCode === 27) {
        this.closeTagsPopup();
      }
    },
    handleClick (e) {
      this.closeTagsPopup(e.target);
    },
    closeTagsPopup (element) {
      if (this.$refs.selectTag) {
        this.$refs.selectTag.closeIfOpen(element);
      }
    },
  },
};
</script>
